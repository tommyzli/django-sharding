<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>The Router | Django Sharding</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.4.2">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-prism/prism.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../docs/components/OtherComponents.html" />
    
    
    <link rel="prev" href="../../docs/components/ReadStrategies.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="1.4" data-basepath="../.." data-revision="Sun Oct 11 2015 18:38:16 GMT-0400 (EDT)">
    

<div class="book-summary">
    <div class="book-search" role="search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Read Me
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="docs/components/index.html">
            
                
                    <a href="../../docs/components/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Components
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="docs/components/IDGeneration.html">
            
                
                    <a href="../../docs/components/IDGeneration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        ID Generation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="docs/components/ShardingFunctions.html">
            
                
                    <a href="../../docs/components/ShardingFunctions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Sharding Functions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="docs/components/ReadStrategies.html">
            
                
                    <a href="../../docs/components/ReadStrategies.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Read Strategies
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="docs/components/Router.html">
            
                
                    <a href="../../docs/components/Router.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        The Router
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="docs/components/OtherComponents.html">
            
                
                    <a href="../../docs/components/OtherComponents.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Other Components
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="docs/installation/index.html">
            
                
                    <a href="../../docs/installation/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Installation
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="docs/installation/HowToShard.html">
            
                
                    <a href="../../docs/installation/HowToShard.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Choosing How To Shard
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="docs/installation/Settings.html">
            
                
                    <a href="../../docs/installation/Settings.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Settings
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="docs/usage/index.html">
            
                
                    <a href="../../docs/usage/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Usage
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="docs/usage/AnotherDB.html">
            
                
                    <a href="../../docs/usage/AnotherDB.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Store Models on Another DB
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="docs/usage/ShardingAModel.html">
            
                
                    <a href="../../docs/usage/ShardingAModel.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Sharding A Model
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="docs/usage/Migrations.html">
            
                
                    <a href="../../docs/usage/Migrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Model Migration
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="docs/usage/DataMigrations.html">
            
                
                    <a href="../../docs/usage/DataMigrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Data Migrations
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="docs/advanced/index.html">
            
                
                    <a href="../../docs/advanced/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Advanced Topics
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="docs/advanced/ReplicationLag.html">
            
                
                    <a href="../../docs/advanced/ReplicationLag.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Replication Lag
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="docs/advanced/Rebalancing.html">
            
                
                    <a href="../../docs/advanced/Rebalancing.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        Shard Rebalancing
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="CHANGES.html">
            
                
                    <a href="../../CHANGES.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Change Log
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Django Sharding</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <a id="edit-link" href="https://github.com/JBKahn/django-sharding/tree/master/docs/components/Router.md" class="btn fa fa-edit pull-left">&nbsp;&nbsp;Edit This Page</a><h1 id="the-router">The Router</h1>
<p>In this library I&apos;ve included a single router, which uses the previous components. Here we will go through the various elements of the router.</p>
<h4 id="choosing-a-database-to-read-from">Choosing a Database to Read From</h4>
<p>The first thing that it checks for is whether or not that database is non-sharded but routed to a database that is not <code>deafult</code>. If that is the case, then we know to send you to that database.</p>
<p>On the other hard, if the model is sharded then we attempt to choose a shard for the model if we are provided an instance. In that case, we either have already chosen a shard (for example, we read this previously and are attempting a refresh) or we need to ask the instance how to get it&apos;s shard. For now, you can ignore the use of a shard group as that will come up later in the guide.</p>
<p>If neither of these two cases are known, we return <code>None</code> lettings Django know that our router has no opinion on what to do.</p>
<p>Note that the <code>self.get_read_db_routing_strategy</code> is not included here as that will be adressed in another section.</p>
<pre><code class="lang-python">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard_for_instance</span><span class="hljs-params">(self, instance)</span>:</span>
        <span class="hljs-keyword">return</span> instance._state.db <span class="hljs-keyword">or</span> instance.get_shard()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_read</span><span class="hljs-params">(self, model, **hints)</span>:</span>
        specific_database = self.get_specific_database_or_none(model)
        <span class="hljs-keyword">if</span> specific_database:
            <span class="hljs-keyword">return</span> specific_database

        <span class="hljs-keyword">if</span> self.get_shard_group_if_sharded_or_none(model):
            instance = hints.get(<span class="hljs-string">&apos;instance&apos;</span>)
            <span class="hljs-keyword">if</span> instance:
                shard = self.get_shard_for_instance(instance)
                shard_group = getattr(model, <span class="hljs-string">&apos;django_sharding__shard_group&apos;</span>, <span class="hljs-keyword">None</span>)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> shard_group:
                    <span class="hljs-keyword">raise</span> Exception(
                        <span class="hljs-string">&apos;Unable to identify the shard_group for a {} model&apos;</span>.format(model)
                    )
                routing_strategy = self.get_read_db_routing_strategy(shard_group)
                <span class="hljs-keyword">return</span> routing_strategy.pick_read_db(shard)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">None</span>
</code></pre>
<h4 id="choosing-a-database-to-write-to">Choosing a Database to Write To</h4>
<p>This works similarly to reading as we need to identify which database to read from. However, the code is simpler as we never want to read from a replica so always write to the primary database.</p>
<pre><code class="lang-python">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_write</span><span class="hljs-params">(self, model, **hints)</span>:</span>
        specific_database = self.get_specific_database_or_none(model)
        <span class="hljs-keyword">if</span> specific_database:
            <span class="hljs-keyword">return</span> specific_database

        <span class="hljs-keyword">if</span> self.get_shard_group_if_sharded_or_none(model):
            instance = hints.get(<span class="hljs-string">&apos;instance&apos;</span>)
            <span class="hljs-keyword">if</span> instance:
                db = self.get_shard_for_instance(instance)
                db_config = settings.DATABASES[db]
                <span class="hljs-keyword">return</span> db_config.get(<span class="hljs-string">&apos;PRIMARY&apos;</span>, db)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">None</span>
</code></pre>
<h4 id="can-items-be-related">Can Items Be Related?</h4>
<p>Typically, we can only allow relations between items on the same database as you cannot have a foreign key across a database. As such, we have to check that both objects are stored on the same database.</p>
<p>First we check if it&apos;s non-sharded but stored on a single database other than <code>default</code>. If they both are, then we only allow the relation is they are stored on the same database. Similarly, the second check looks at the stard status of both items and wether they would be on the same shard or not. If non of these checks are true, then the items are assumed to both be on the default database and the relation is allowed.</p>
<pre><code class="lang-python">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_relation</span><span class="hljs-params">(self, obj1, obj2, **hints)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Only allow relationships between two items which are both on only one database or
        between sharded items on the same shard.
        &quot;&quot;&quot;</span>
        specific_database_for_object_one = self.get_specific_database_or_none(obj1)
        specific_database_for_object_two = self.get_specific_database_or_none(obj2)

        <span class="hljs-keyword">if</span> specific_database_for_object_one != specific_database_for_object_two:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
        <span class="hljs-keyword">elif</span> specific_database_for_object_one:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>

        shard_group_for_object_one = self.get_shard_group_if_sharded_or_none(obj1)
        shard_group_for_object_two = self.get_shard_group_if_sharded_or_none(obj2)

        <span class="hljs-keyword">if</span> shard_group_for_object_one != shard_group_for_object_two:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
        <span class="hljs-keyword">elif</span> self.shard_group_for_object_one:
            <span class="hljs-keyword">return</span> self.get_shard_for_instance(obj1) == self.get_shard_for_instance(obj2)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
</code></pre>
<h4 id="can-i-be-migrated">Can I Be Migrated?</h4>
<p>When running your migrations, the app needs to be able to determine which databases require the migration in order to same developers from having to do this work manually.</p>
<p>As such, we restrict migrations to only those which provide the model they are migrating as well as migrations to primary databases. In the event that a model is on a sepcific database or sharded then we also restrict the migration to those sets of databases. By using the module loading system in Django, we can determine the shard status of a model instance in order to make an informed decision.</p>
<pre><code class="lang-python">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_migrate</span><span class="hljs-params">(self, db, app_label, model_name=None, **hints)</span>:</span>
        <span class="hljs-keyword">if</span> settings.DATABASES[db].get(<span class="hljs-string">&apos;PRIMARY&apos;</span>, <span class="hljs-keyword">None</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span>
        model_name = model_name <span class="hljs-keyword">or</span> hints.get(<span class="hljs-string">&apos;model_name&apos;</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> model_name:
            <span class="hljs-keyword">raise</span> InvalidMigrationException(
                <span class="hljs-string">&apos;Model name not provided in migration,&apos;</span>
                <span class="hljs-string">&apos;please pass a `model_name` with the hints passed into the migration.&apos;</span>
            )

        <span class="hljs-comment"># Sometimes, when extending models from another app i.e. the User Model, the app</span>
        <span class="hljs-comment"># label is the app label of the app where the change is defined but to app with</span>
        <span class="hljs-comment"># the model is passed in with the model name.</span>
        <span class="hljs-keyword">try</span>:
            app = apps.get_app_config(app_label)
            model = app.get_model(model_name)
        <span class="hljs-keyword">except</span> LookupError:
            app_label = model_name.split(<span class="hljs-string">&apos;.&apos;</span>)[<span class="hljs-number">0</span>]
            app = apps.get_app_config(app_label)
            model = app.get_model(model_name[len(app_label) + <span class="hljs-number">1</span>:])

        single_database = self.get_specific_database_or_none(model)
        shard_group = self.get_shard_group_if_sharded_or_none(model)
        <span class="hljs-keyword">if</span> shard_group <span class="hljs-keyword">and</span> single_database:
            <span class="hljs-keyword">raise</span> InvalidMigrationException(
                <span class="hljs-string">&apos;Model marked as both sharded and on a single database, &apos;</span>
                <span class="hljs-string">&apos;unable to determine where to run migrations for {}.&apos;</span>.format(model_name)
            )
        <span class="hljs-keyword">if</span> single_database:
            <span class="hljs-keyword">return</span> db == single_database
        <span class="hljs-keyword">if</span> shard_group:
            <span class="hljs-keyword">return</span> settings.DATABASES[db][<span class="hljs-string">&apos;SHARD_GROUP&apos;</span>] == shard_group
        <span class="hljs-keyword">return</span> db == <span class="hljs-string">&apos;default&apos;</span>
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../docs/components/ReadStrategies.html" class="navigation navigation-prev " aria-label="Previous page: Read Strategies"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../docs/components/OtherComponents.html" class="navigation navigation-next " aria-label="Next page: Other Components"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"edit-link":{"base":"https://github.com/JBKahn/django-sharding/tree/master","label":"Edit This Page"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
