<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Sharding Functions | Django Sharding</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.4.2">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-prism/prism.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../docs/components/ReadStrategies.html" />
    
    
    <link rel="prev" href="../../docs/components/IDGeneration.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="1.2" data-basepath="../.." data-revision="Sun Oct 11 2015 18:38:16 GMT-0400 (EDT)">
    

<div class="book-summary">
    <div class="book-search" role="search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Read Me
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="docs/components/index.html">
            
                
                    <a href="../../docs/components/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Components
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="docs/components/IDGeneration.html">
            
                
                    <a href="../../docs/components/IDGeneration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        ID Generation
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="1.2" data-path="docs/components/ShardingFunctions.html">
            
                
                    <a href="../../docs/components/ShardingFunctions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Sharding Functions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="docs/components/ReadStrategies.html">
            
                
                    <a href="../../docs/components/ReadStrategies.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Read Strategies
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="docs/components/Router.html">
            
                
                    <a href="../../docs/components/Router.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        The Router
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="docs/components/OtherComponents.html">
            
                
                    <a href="../../docs/components/OtherComponents.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Other Components
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="docs/installation/index.html">
            
                
                    <a href="../../docs/installation/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Installation
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="docs/installation/HowToShard.html">
            
                
                    <a href="../../docs/installation/HowToShard.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Choosing How To Shard
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="docs/installation/Settings.html">
            
                
                    <a href="../../docs/installation/Settings.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Settings
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="docs/usage/index.html">
            
                
                    <a href="../../docs/usage/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Usage
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="docs/usage/AnotherDB.html">
            
                
                    <a href="../../docs/usage/AnotherDB.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Store Models on Another DB
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="docs/usage/ShardingAModel.html">
            
                
                    <a href="../../docs/usage/ShardingAModel.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Sharding A Model
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="docs/usage/Migrations.html">
            
                
                    <a href="../../docs/usage/Migrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Model Migration
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="docs/usage/DataMigrations.html">
            
                
                    <a href="../../docs/usage/DataMigrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Data Migrations
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="docs/advanced/index.html">
            
                
                    <a href="../../docs/advanced/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Advanced Topics
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="docs/advanced/ReplicationLag.html">
            
                
                    <a href="../../docs/advanced/ReplicationLag.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Replication Lag
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="docs/advanced/Rebalancing.html">
            
                
                    <a href="../../docs/advanced/Rebalancing.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        Shard Rebalancing
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="CHANGES.html">
            
                
                    <a href="../../CHANGES.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Change Log
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Django Sharding</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <a id="edit-link" href="https://github.com/JBKahn/django-sharding/tree/master/docs/components/ShardingFunctions.md" class="btn fa fa-edit pull-left">&nbsp;&nbsp;Edit This Page</a><h1 id="sharding-functions">Sharding Functions</h1>
<p>A sharding function is a function that is used to choose a shard for a group of objects. This is composed of two core functionts that decide how to pick a shard in the case where we haven&apos;t previously chosen one and how to retrieve a previously chosen shard. This is split into the two functions <code>pick_shard</code> and <code>get_shard</code>. There are times when those two functions do the same thing, but in many cases the choice to pick a shard is non-deterministic and so you&apos;ll need to read from a stored value in <code>get_shard</code>.</p>
<p>Note: This library does support Functional Sharding, which allows you to have multiple groups of shards or <code>sharding_group</code>s. This would allow you to store all of the objects of type A on one set of shards and all of the items of type B on another set of shards. However, the author does not suggest having multiple sharding functions and splitting data for one related item across multiple shards. Doing so prevents you from doing database joins on those items and typically the desire to split data in this way suggests that the whole system should be split. It is much easier and simpler to store all related data on a single shard.</p>
<p>An interface for a sharding strategy looks as follows:</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseBucketingStrategy</span><span class="hljs-params">(object)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_group=<span class="hljs-string">&apos;default&apos;</span>)</span>:</span>
        self.shard_group = shard_group

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shards</span><span class="hljs-params">(self, databases)</span>:</span>
        <span class="hljs-keyword">return</span> [
            name <span class="hljs-keyword">for</span>( name, config) <span class="hljs-keyword">in</span> databases
            <span class="hljs-keyword">if</span> (
                config.get(<span class="hljs-string">&apos;SHARD_GROUP&apos;</span>) == self.shard_group <span class="hljs-keyword">and</span>
                <span class="hljs-keyword">not</span> config.get(<span class="hljs-string">&apos;PRIMARY&apos;</span>)
            )
        ]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pick_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Returns the shard for the model which has not previously been bucketed
        into a shard.
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">raise</span> <span class="hljs-built_in">NotImplemented</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Returns the shard for a model which has already been assigned a shard.
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">raise</span> <span class="hljs-built_in">NotImplemented</span>
</code></pre>
<p>There are multiple ways to impliment the above code and I will provide, as an example, the functions that are shipped with this packages. There are two types of strategies that you may wish to use. The first kind, deterministic functions, will always return the same bucket and storage of the chosen shard is optional. The second kind, non-deterministic functions, require the shard to be stored as there is no way to derive the shard that belongs to a group of objects</p>
<h4 id="deterministic-functions">Deterministic Functions</h4>
<p>I have not shipped this package with any truely deterministic functions as all the ones that I&apos;ve implimented either use randomness, order or depend on the number of shards in the system as the time that the shard is picked. This is not highly reccomended andis a considerably harder method but could still be implimented. For example, if the number of shards were never going to change, you could do something like this:</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModBucketingStrategy</span><span class="hljs-params">(BaseBucketingStrategy)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    A shard selection strategy that assigns shards based on the mod of the
    models pk.
    &quot;&quot;&quot;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_group, databases)</span>:</span>
        super(RoundRobinBucketingStrategy, self).__init__(shard_group)
        self.shards = self.get_shards(databases)
        self.shards.sort()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pick_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> self.shards[hash(str(model_sharded_by.pk)) % len(self.shards)]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> self.pick_shard(model_sharded_by)
</code></pre>
<h4 id="non-deterministic-functions">Non-deterministic Functions</h4>
<h5 id="random-bucketing-strategy">Random Bucketing Strategy</h5>
<p>As the name says, this method chooses a random shard and ends up storing it on the model in question.</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RandomBucketingStrategy</span><span class="hljs-params">(BaseShardedModelBucketingStrategy)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    A shard selection strategy that assigns shards randomly.
    This is non-deterministic and this strategy assumes the shard is saved to
    the model.
    &quot;&quot;&quot;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_group, databases)</span>:</span>
        super(RoundRobinBucketingStrategy, self).__init__(shard_group)
        self.shards = self.get_shards(databases)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pick_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> choice(self.shards)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> model_sharded_by.shard
</code></pre>
<h5 id="round-robin-bucketing-strategy">Round-Robin Bucketing Strategy</h5>
<p>This uses a round-robin approach to choose a shard in order to maintain a balance across the system so that the proportion of new instances is even across the shards:</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoundRobinBucketingStrategy</span><span class="hljs-params">(BaseShardedModelBucketingStrategy)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_group, databases)</span>:</span>
        super(RoundRobinBucketingStrategy, self).__init__(shard_group)
        shards = self.get_shards(databases)
        max_index = max(<span class="hljs-number">0</span>, len(shards) - <span class="hljs-number">1</span>)
        starting_index = randint(<span class="hljs-number">0</span>, max_index)
        shards = shards[starting_index:] + shards[:starting_index]
        self._shards_cycle = cycle(shards)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pick_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> self._shards_cycle.next()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> model_sharded_by.shard
</code></pre>
<p>Since this is initialized at app initialization time, it begins the cycle at a random index, otherwise the first shard would always be imbalanced. </p>
<h5 id="mod-bucketing-strategy">Mod Bucketing Strategy</h5>
<p>This works the same way as the non-deterministic strategy but allows you to add shards by storing them on the model.</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModBucketingStrategy</span><span class="hljs-params">(BaseBucketingStrategy)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;
    A shard selection strategy that assigns shards based on the mod of the
    models pk.
    &quot;&quot;&quot;</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_group, databases)</span>:</span>
        super(RoundRobinBucketingStrategy, self).__init__(shard_group)
        self.shards = self.get_shards(databases)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pick_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> self.shards[hash(str(model_sharded_by.pk)) % len(self.shards)]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard</span><span class="hljs-params">(self, model_sharded_by)</span>:</span>
        <span class="hljs-keyword">return</span> model_sharded_by.shard
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../docs/components/IDGeneration.html" class="navigation navigation-prev " aria-label="Previous page: ID Generation"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../docs/components/ReadStrategies.html" class="navigation navigation-next " aria-label="Next page: Read Strategies"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"edit-link":{"base":"https://github.com/JBKahn/django-sharding/tree/master","label":"Edit This Page"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
