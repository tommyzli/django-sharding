<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Choosing How To Shard | Django Sharding</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.4.2">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-prism/prism.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../docs/installation/Settings.html" />
    
    
    <link rel="prev" href="../../docs/installation/index.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="2.1" data-basepath="../.." data-revision="Sun Oct 11 2015 18:38:16 GMT-0400 (EDT)">
    

<div class="book-summary">
    <div class="book-search" role="search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Read Me
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="docs/components/index.html">
            
                
                    <a href="../../docs/components/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Components
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="docs/components/IDGeneration.html">
            
                
                    <a href="../../docs/components/IDGeneration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        ID Generation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="docs/components/ShardingFunctions.html">
            
                
                    <a href="../../docs/components/ShardingFunctions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Sharding Functions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="docs/components/ReadStrategies.html">
            
                
                    <a href="../../docs/components/ReadStrategies.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Read Strategies
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="docs/components/Router.html">
            
                
                    <a href="../../docs/components/Router.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        The Router
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="docs/components/OtherComponents.html">
            
                
                    <a href="../../docs/components/OtherComponents.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Other Components
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="docs/installation/index.html">
            
                
                    <a href="../../docs/installation/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Installation
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="2.1" data-path="docs/installation/HowToShard.html">
            
                
                    <a href="../../docs/installation/HowToShard.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Choosing How To Shard
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="docs/installation/Settings.html">
            
                
                    <a href="../../docs/installation/Settings.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Settings
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="docs/usage/index.html">
            
                
                    <a href="../../docs/usage/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Usage
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="docs/usage/AnotherDB.html">
            
                
                    <a href="../../docs/usage/AnotherDB.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Store Models on Another DB
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="docs/usage/ShardingAModel.html">
            
                
                    <a href="../../docs/usage/ShardingAModel.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Sharding A Model
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="docs/usage/Migrations.html">
            
                
                    <a href="../../docs/usage/Migrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Model Migration
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="docs/usage/DataMigrations.html">
            
                
                    <a href="../../docs/usage/DataMigrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Data Migrations
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="docs/advanced/index.html">
            
                
                    <a href="../../docs/advanced/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Advanced Topics
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="docs/advanced/ReplicationLag.html">
            
                
                    <a href="../../docs/advanced/ReplicationLag.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Replication Lag
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="docs/advanced/Rebalancing.html">
            
                
                    <a href="../../docs/advanced/Rebalancing.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        Shard Rebalancing
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="CHANGES.html">
            
                
                    <a href="../../CHANGES.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Change Log
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Django Sharding</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <a id="edit-link" href="https://github.com/JBKahn/django-sharding/tree/master/docs/installation/HowToShard.md" class="btn fa fa-edit pull-left">&nbsp;&nbsp;Edit This Page</a><h1 id="choosing-how-to-shard">Choosing How To Shard</h1>
<p>When deciding how to shard, there are several considerations to make that will impact your setup.</p>
<h3 id="shard-groups">Shard Groups</h3>
<p>You can think of shard groups as disticts groups of databases so that you can limit sharded data to a subset of the shards included in your application. For example, you may have six shards in your application and use three for one item and three to store another. The <code>default</code> shard group is used when no shard groups are given in the settings file.</p>
<p>While you may use this library however you&apos;d like, the author reccomends that you only use the <code>default</code> shard group. This is because you will often want to do joins on the data later, when it will not be in the same set of databases, or the data is so split that it probably does not belong in the same application as the other data. In either case, it is simpler and easier to use one shard group over many.</p>
<h3 id="storing-shards">Storing Shards</h3>
<p>Often you&apos;ll want to store the shard when you pick one for an instance. For example, if you were to shard your data by user then you&apos;ll want to store that shard somewhere. You&apos;ll likely want to store it on the user, but perhaps all your users have multiple Group instances and you&apos;d like to store this data on the Group rather than the user, than that is an option too. Both are supported by the library, but you must decide where to store the shard unless your sharding function is deterministic (as discussed earlier in the component section of these docs).</p>
<h3 id="sharding-functions">Sharding Functions</h3>
<p>In order to shard your data, you need to decide how to pick those shards. For example, it you were to shard by User then how do you pick a shard given a User? You may choose to inspect the user or to try to balance the load across all the databases. There are multiple ways to do that and several included as discussed in the component section of these docs.</p>
<h3 id="will-i-use-replicate-databases">Will I Use Replicate Databases?</h3>
<p>To an app without replicate databases, the read strategy for a router is unimportant. However, if you have replicates then you may want to decide how to use them. You may want to read from them evenly, randomly or using a known ratio as discussed in the components section of the docs. While replicates may be useful, the author feels that you should not use them in your production environment. As discussed by <a href="https://engineering.pinterest.com/blog/sharding-pinterest-how-we-scaled-our-mysql-fleet" target="_blank">pintrest</a> in their Design Pgilosophies, you then have to take into account replication lag time as well as other issues. It would be simplier and easier to just include more shards.</p>
<h3 id="logical-vs-physical-sharding">Logical vs Physical Sharding</h3>
<p>There are two types of shards you can create, logical shards and physical shards. A logical shard is splitting data into multiple databases on the same physical node. A physical shard is when splitting data across multiple nodes. It is the reccomendation of the author that you start using both. The reason is that it&apos;s easier to rebalance logical shards across machines that rebalance the data in physical shards. For example, imagine your application were to have two physical shards defined like so:</p>
<pre><code class="lang-python">DATABASES = database_configs(databases_dict={
    <span class="hljs-string">&apos;unsharded_databases&apos;</span>: [
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;default&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@localhost/sharding&apos;</span>
        }
    ],
    <span class="hljs-string">&apos;sharded_databases&apos;</span>: [
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;app_shard_001&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;SHARD_001_DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@some_host_01/shard_01&apos;</span>
        },
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;app_shard_002&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;SHARD_002_DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@some_host_02/shard_02&apos;</span>
        },
    ]
})
</code></pre>
<p>Suppose they were nearing capacity then adding a third would result in a terrible data imbalance. The only way to rebalance them is to move related data to a new shard. That&apos;s a difficult task which we&apos;ll discuss in the advanced section of this guide.</p>
<p>On the other hand, if you had used two physical nodes with two logical shards each, which you&apos;d define like so:</p>
<pre><code class="lang-python">DATABASES = database_configs(databases_dict={
    <span class="hljs-string">&apos;unsharded_databases&apos;</span>: [
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;default&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@localhost/sharding&apos;</span>
        }
    ],
    <span class="hljs-string">&apos;sharded_databases&apos;</span>: [
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;app_shard_001&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;SHARD_001_DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@some_host_01/shard_01&apos;</span>
        },
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;app_shard_002&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;SHARD_002_DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@some_host_01/shard_02&apos;</span>
        },
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;app_shard_003&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;SHARD_003_DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@some_host_02/shard_03&apos;</span>
        },
        {
            <span class="hljs-string">&apos;name&apos;</span>: <span class="hljs-string">&apos;app_shard_004&apos;</span>,
            <span class="hljs-string">&apos;environment_variable&apos;</span>: <span class="hljs-string">&apos;SHARD_004_DATABASE_URL&apos;</span>,
            <span class="hljs-string">&apos;default_database_url&apos;</span>: <span class="hljs-string">&apos;postgres://user:pwd@some_host_02/shard_04&apos;</span>
        },
    ]
})
</code></pre>
<p>Then, as a way to rebalance the data, you could move either <code>app_shard_003</code> or <code>app_shard_002</code> to <code>some_host_03</code>, your new machine. And all you&apos;d have to do is copy over the database and change <code>&apos;postgres://user:pwd@some_host_02/shard_03&apos;</code> to <code>&apos;postgres://user:pwd@some_host_03/shard_03&apos;</code>. This wouldn&apos;t leave you incredibly balanced with only two logical shards per node, so the author suggests at least ten logical shards per node. That way you can easily rebalance data as your data-set grows.</p>
<h3 id="many-shards-or-few-shards">Many Shards or Few Shards?</h3>
<p>The author reccomends that you create more shards than you think are necessary. Extra logical shards allow you to much more easily rebalance data across physical nodes in the future. Also, by Storing data on different machines, you increase the number of connections to your databases.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../docs/installation/index.html" class="navigation navigation-prev " aria-label="Previous page: Installation"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../docs/installation/Settings.html" class="navigation navigation-next " aria-label="Next page: Settings"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"edit-link":{"base":"https://github.com/JBKahn/django-sharding/tree/master","label":"Edit This Page"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
