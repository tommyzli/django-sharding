<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Model Migration | Django Sharding</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.4.2">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-prism/prism.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../docs/usage/DataMigrations.html" />
    
    
    <link rel="prev" href="../../docs/usage/ShardingAModel.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="3.3" data-basepath="../.." data-revision="Sun Oct 11 2015 18:38:16 GMT-0400 (EDT)">
    

<div class="book-summary">
    <div class="book-search" role="search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Read Me
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="docs/components/index.html">
            
                
                    <a href="../../docs/components/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Components
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="docs/components/IDGeneration.html">
            
                
                    <a href="../../docs/components/IDGeneration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        ID Generation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="docs/components/ShardingFunctions.html">
            
                
                    <a href="../../docs/components/ShardingFunctions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Sharding Functions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="docs/components/ReadStrategies.html">
            
                
                    <a href="../../docs/components/ReadStrategies.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Read Strategies
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="docs/components/Router.html">
            
                
                    <a href="../../docs/components/Router.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        The Router
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="docs/components/OtherComponents.html">
            
                
                    <a href="../../docs/components/OtherComponents.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Other Components
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="docs/installation/index.html">
            
                
                    <a href="../../docs/installation/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Installation
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="docs/installation/HowToShard.html">
            
                
                    <a href="../../docs/installation/HowToShard.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Choosing How To Shard
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="docs/installation/Settings.html">
            
                
                    <a href="../../docs/installation/Settings.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Settings
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="docs/usage/index.html">
            
                
                    <a href="../../docs/usage/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Usage
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="docs/usage/AnotherDB.html">
            
                
                    <a href="../../docs/usage/AnotherDB.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Store Models on Another DB
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="docs/usage/ShardingAModel.html">
            
                
                    <a href="../../docs/usage/ShardingAModel.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Sharding A Model
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="3.3" data-path="docs/usage/Migrations.html">
            
                
                    <a href="../../docs/usage/Migrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Model Migration
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="docs/usage/DataMigrations.html">
            
                
                    <a href="../../docs/usage/DataMigrations.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Data Migrations
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="docs/advanced/index.html">
            
                
                    <a href="../../docs/advanced/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Advanced Topics
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="docs/advanced/ReplicationLag.html">
            
                
                    <a href="../../docs/advanced/ReplicationLag.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Replication Lag
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="docs/advanced/Rebalancing.html">
            
                
                    <a href="../../docs/advanced/Rebalancing.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        Shard Rebalancing
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="CHANGES.html">
            
                
                    <a href="../../CHANGES.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Change Log
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Django Sharding</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <a id="edit-link" href="https://github.com/JBKahn/django-sharding/tree/master/docs/usage/Migrations.md" class="btn fa fa-edit pull-left">&nbsp;&nbsp;Edit This Page</a><h1 id="creating-running-model-migrations">Creating &amp; Running Model Migrations</h1>
<p>In order to make running migrations easier, a new migration command is included with the package when you add <code>django_sharding</code> to your <code>INSTALLED_APPS</code> list in your settings file. The net effect is that calling <code>python manage.py migrate</code> or <code>python manage.py makemigrations</code> will work as they did before for all model migrations.</p>
<p>Here&apos;s how the old command was wrapped to handle sharding:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> django.core.management.commands.migrate <span class="hljs-keyword">import</span> Command <span class="hljs-keyword">as</span> MigrationCommand

<span class="hljs-keyword">from</span> django_sharding_library.exceptions <span class="hljs-keyword">import</span> InvalidMigrationException


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Command</span><span class="hljs-params">(MigrationCommand)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle</span><span class="hljs-params">(self, *args, **options)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Wrap the original command and runs migrate on all the databases. When
        a migration is run on a DB it is not supposed to migrate, the router
        detects this and performs no actions on that database. Each database
        tracks its own history of migrations so that you can run them on a
        specific database at a time.
        &quot;&quot;&quot;</span>

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options[<span class="hljs-string">&apos;database&apos;</span>] <span class="hljs-keyword">or</span> options[<span class="hljs-string">&apos;database&apos;</span>] == <span class="hljs-string">&apos;all&apos;</span>:
            databases = self.get_all_but_replica_dbs()
        <span class="hljs-keyword">elif</span> options[<span class="hljs-string">&apos;database&apos;</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.get_all_but_replica_dbs():
            <span class="hljs-keyword">raise</span> InvalidMigrationException(
                <span class="hljs-string">&apos;You must migrate an existing non-primary DB.&apos;</span>
            )
        <span class="hljs-keyword">else</span>:
            databases = [options[<span class="hljs-string">&apos;database&apos;</span>]]

        <span class="hljs-keyword">for</span> database <span class="hljs-keyword">in</span> databases:
            options[<span class="hljs-string">&apos;database&apos;</span>] = database
            <span class="hljs-comment"># Writen in green text to stand out from the surrouding headings</span>
            <span class="hljs-keyword">if</span> options[<span class="hljs-string">&apos;verbosity&apos;</span>] &gt;= <span class="hljs-number">1</span>:
                self.stdout.write(self.style.MIGRATE_SUCCESS(
                    <span class="hljs-string">&quot;\nDatabase: {}\n&quot;</span>).format(database)
                )
            super(Command, self).handle(*args, **options)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_but_replica_dbs</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Return a list of primary databases, used to prevent migrations from
        being run on replication databases.
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> filter(
            <span class="hljs-keyword">lambda</span> db: <span class="hljs-keyword">not</span> settings.DATABASES[db].get(<span class="hljs-string">&apos;PRIMARY&apos;</span>, <span class="hljs-keyword">None</span>),
            settings.DATABASES.keys()
        )

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_arguments</span><span class="hljs-params">(self, parser)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Overrides the existing Database command to accept any primary database as
        well as the keywork `all` which is the new default value.
        &quot;&quot;&quot;</span>
        super(Command, self).add_arguments(parser)
        parser._option_string_actions[<span class="hljs-string">&apos;--database&apos;</span>].default = <span class="hljs-keyword">None</span>
        parser._option_string_actions[<span class="hljs-string">&apos;--database&apos;</span>].help = (
            <span class="hljs-string">u&apos;Nominates a database to synchronize. Defaults to all databases.&apos;</span>
        )
        parser._option_string_actions[<span class="hljs-string">&apos;--database&apos;</span>].choices = (
            [<span class="hljs-string">&apos;all&apos;</span>] + self.get_all_but_replica_dbs()
        )
</code></pre>
<p>By using the included router, it&apos;s as simple as calling migrate on all the primary databases in the system and allowing the system to decide which databases to run the migration on. The above changes were made to make the interface more simple than having to specify all the relevant databases.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../docs/usage/ShardingAModel.html" class="navigation navigation-prev " aria-label="Previous page: Sharding A Model"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../docs/usage/DataMigrations.html" class="navigation navigation-next " aria-label="Next page: Data Migrations"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-edit-link/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"edit-link":{"base":"https://github.com/JBKahn/django-sharding/tree/master","label":"Edit This Page"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
